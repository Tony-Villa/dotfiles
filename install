#!/bin/bash
# set -x
set -e
{ #prevent exec until fully downloaded?

    DIR=~/.dotfiles

    function fetch_files () {
        if [ "$CODESPACES" = true ] ; then
            echo "Running in codespaces..."
            DIR="/workspaces/.codespaces/.persistedshare/dotfiles"
        fi

        if [ ! -d $DIR ]; then
            git clone https://github.com/jsg2021/dotfiles.git $DIR
        fi

        cd $DIR
        git submodule update --init --recursive
    }

    function install_tools() {

        curl -fsSL https://fnm.vercel.app/install | bash

        if [ "$CODESPACES" = true ] ; then
            echo "Running in codespaces...skipped apps"
            return
        else
            sh ./scripts/install_1password
            sh ./scripts/install_github
        fi

        sh ./scripts/install_bat
        sh ./scripts/install_fzf
        sh ./scripts/install_lsd
    }

    function install_homebrew() {
        bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        eval "$(/opt/homebrew/bin/brew shellenv)"
    }
    
    function install_configs () {
        FILES=(gitconfig bash_profile vimrc zshrc)
        for f in "${FILES[@]}"
        do
            if [ -f ~/.$f ]; then
                echo "~/.$f exists...remove to use .dotfile version";
            else
                rm -f ~/.$f
                ln -s "$DIR/configs/$f" ~/.$f
            fi
        done

        if [ -f ~/.vim/colors/solarized.vim ]; then
            echo "~/.vim/colors/solarized.vim exists...remove to use .dotfile version"
        else
            mkdir -p ~/.vim/colors
            ln -s "$DIR/vim-colors-solarized/colors/solarized.vim" ~/.vim/colors/solarized.vim
        fi


        zsh -c "zstyle ':omz:update' mode reminder"
        zsh -c "zstyle ':omz:update' frequency 30"
        # set shell 
        if [[ "$SHELL" != $(which zsh) ]]; then 
            chsh -s $(which zsh)
            if [[ "$OSTYPE" != "darwin"* ]]; then
                echo "Reboot for SHELL change to take effect."
            fi
        fi
    }

    function install_linux () {
        if [ "$CODESPACES" = true ] ; then
            echo "Running in codespaces...skip install_linux"
            return
        fi

        if command -v dnf &> /dev/null; then 
            sudo dnf install -y xclip xsel
        elif command -v apt-get &> /dev/null; then
            sudo apt-get install -y xclip xsel
        fi

        sudo ln -s ~/.dotfiles/scripts/goto-windows /usr/local/bin/goto-windows &&
            mkdir -p ~/.local/share/applications &&
            ln -s "$DIR/configs/linux/uefi-reboot.desktop" ~/.local/share/applications/uefi-reboot.desktop &&
            ln -s "$DIR/configs/linux/goto-windows.desktop" ~/.local/share/applications/goto-windows.desktop
    }

    function install_macos() {
        if [ "$CODESPACES" = true ] ; then
            echo "Running in codespaces...skip install_macos"
            return
        fi
        install_homebrew
    }


    fetch_files

    if [[ "$OSTYPE" == "darwin"* ]]; then
        install_macos
    else  
        install_linux
    fi

    install_configs
    install_tools
}